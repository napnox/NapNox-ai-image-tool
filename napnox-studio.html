<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>NapNox Studio | AI Image Generator</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
  
  <style>
    :root {
      --background-color: #f0f2f5;
      --panel-background: rgba(255, 255, 255, 0.65);
      --panel-border: rgba(255, 255, 255, 0.3);
      --text-color: #1c1e21;
      --text-light: #606770;
      --border-color: #ccd0d5;
      --accent-color: #00A699;
      --accent-gradient: linear-gradient(45deg, #00A699, #007369);
      --font-family: 'Poppins', sans-serif;
      --shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
      --border-radius: 16px;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    @keyframes animate-bg {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }

    body {
      font-family: var(--font-family);
      background-color: var(--background-color);
      background: linear-gradient(135deg, #f0f2f5, #e0f2f1);
      background-size: 200% 200%;
      animation: animate-bg 20s ease infinite;
      color: var(--text-color);
      line-height: 1.6;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    .hidden {
      display: none !important;
    }

    .container {
      max-width: 1440px;
      margin: 0 auto;
      padding: 0 24px;
    }

    /* Header */
    header {
      background-color: transparent;
      padding: 24px 0;
    }
    header .container {
      display: flex;
      align-items: center;
      gap: 16px;
    }
    .logo {
      font-weight: 600;
      font-size: 24px;
    }
    .logo strong {
        font-weight: 400;
        color: var(--text-light);
    }

    /* Main Layout */
    main {
      padding: 0 0 32px 0;
    }
    .main-container {
      display: grid;
      grid-template-columns: 480px 1fr;
      gap: 32px;
      align-items: flex-start;
    }
    #controls-panel, #results-panel {
      background: var(--panel-background);
      border-radius: var(--border-radius);
      box-shadow: var(--shadow);
      padding: 32px;
      border: 1px solid var(--panel-border);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
    }

    /* Controls Panel & Form */
    #prompt-form h2, #results-panel h2 {
      font-size: 24px;
      margin-bottom: 24px;
      font-weight: 600;
    }
    #prompt-form h3 {
      font-size: 18px;
      margin-top: 32px;
      margin-bottom: 16px;
      font-weight: 600;
      border-top: 1px solid var(--border-color);
      padding-top: 32px;
    }
    .form-group {
      margin-bottom: 16px;
    }
    .form-group.full-width {
        grid-column: 1 / -1;
    }
    .form-group label {
      display: block;
      font-weight: 500;
      margin-bottom: 8px;
      font-size: 14px;
    }
    input[type="file"] {
      display: none;
    }
    textarea, select {
      width: 100%;
      padding: 12px 16px;
      border-radius: 10px;
      border: 1px solid var(--border-color);
      font-family: var(--font-family);
      font-size: 15px;
      background-color: #fff;
      color: var(--text-color);
      transition: border-color 0.2s, box-shadow 0.2s;
    }
    textarea:focus, select:focus {
      outline: none;
      border-color: var(--accent-color);
      box-shadow: 0 0 0 3px rgba(0, 166, 153, 0.15);
    }
    textarea {
      resize: vertical;
    }

    /* Segmented Control for Generation Source */
    .segmented-control {
        display: flex;
        width: 100%;
        border: 1px solid var(--border-color);
        border-radius: 10px;
        overflow: hidden;
        background-color: #f0f2f5;
    }
    .segmented-control input[type="radio"] {
        display: none;
    }
    .segmented-control label {
        flex: 1;
        text-align: center;
        padding: 10px;
        cursor: pointer;
        font-weight: 500;
        font-size: 14px;
        margin: 0;
        transition: background-color 0.2s, color 0.2s;
        user-select: none;
    }
    .segmented-control input[type="radio"]:checked + label {
        background-color: var(--accent-color);
        color: white;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .segmented-control label:not(:last-of-type) {
        border-right: 1px solid var(--border-color);
    }


    /* Image Upload */
    .image-preview-wrapper {
      border: 2px dashed var(--border-color);
      border-radius: 12px;
      cursor: pointer;
      position: relative;
      width: 100%;
      aspect-ratio: 16 / 9;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      background-color: rgba(255, 255, 255, 0.5);
      transition: border-color 0.2s, background-color 0.2s;
    }
    .image-preview-wrapper:hover {
      border-color: var(--accent-color);
      background-color: rgba(230, 247, 245, 0.7);
    }
    #upload-placeholder {
      text-align: center;
      color: var(--text-light);
    }
    #upload-placeholder svg {
      margin-bottom: 8px;
      color: var(--accent-color);
    }
    #image-preview {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .remove-image-btn {
        position: absolute;
        top: 8px;
        right: 8px;
        width: 28px;
        height: 28px;
        border-radius: 50%;
        background-color: rgba(0, 0, 0, 0.6);
        color: white;
        border: none;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 20px;
        line-height: 1;
        z-index: 10;
        transition: background-color 0.2s, transform 0.2s;
    }
    .remove-image-btn:hover {
        background-color: rgba(0, 0, 0, 0.8);
        transform: scale(1.1);
    }

    /* Filters Grid */
    .filters-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
    }

    /* Generate Button */
    #generate-btn {
      width: 100%;
      padding: 16px;
      font-size: 18px;
      font-weight: 600;
      color: white;
      background: var(--accent-gradient);
      border: none;
      border-radius: 10px;
      cursor: pointer;
      margin-top: 24px;
      transition: transform 0.2s, box-shadow 0.2s;
    }
    #generate-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(0, 166, 153, 0.25);
    }
    #generate-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    /* Results Panel */
    #results-panel {
      position: relative;
      min-height: 800px;
      transition: min-height 0.3s ease;
    }
    #results-panel.has-results {
        min-height: initial;
    }
    #results-placeholder {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
      color: var(--text-light);
      padding: 48px;
      border: 2px dashed var(--border-color);
      border-radius: var(--border-radius);
      transition: all 0.3s ease;
    }
    #results-placeholder svg {
      margin-bottom: 24px;
      color: var(--accent-color);
      opacity: 0.6;
    }
    #results-placeholder h3 {
      font-size: 20px;
      font-weight: 600;
      color: var(--text-color);
      margin-bottom: 8px;
    }
    #results-placeholder p {
        max-width: 400px;
    }
    #results-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 24px;
    }
    .result-card {
      background-color: #fff;
      border-radius: var(--border-radius);
      overflow: hidden;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
      border: 1px solid var(--border-color);
      display: flex;
      flex-direction: column;
      position: relative;
      transition: transform 0.2s, box-shadow 0.2s;
    }
    .result-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 8px 24px rgba(0,0,0,0.1);
    }
    .result-card img {
      width: 100%;
      aspect-ratio: 1 / 1;
      object-fit: cover;
      background-color: #e9ecef;
    }
    .result-card .prompt-info {
      padding: 16px;
      flex-grow: 1;
      display: flex;
      flex-direction: column;
    }
    .result-card .prompt-text {
      font-size: 14px;
      margin-bottom: 16px;
      flex-grow: 1;
      color: var(--text-light);
    }
    .result-card .card-actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    .result-card .card-actions button {
      padding: 8px 12px;
      border-radius: 8px;
      border: 1px solid var(--border-color);
      background-color: #fff;
      color: var(--text-color);
      cursor: pointer;
      font-family: var(--font-family);
      font-weight: 500;
      font-size: 13px;
      transition: background-color 0.2s, color 0.2s, border-color 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
    }
    .result-card .card-actions button:hover {
      background-color: #f0f2f5;
      border-color: #b0b3b8;
    }
    .result-card .copy-btn {
        flex-grow: 1;
    }
    .result-card .card-actions button.copied {
      background-color: #28a745;
      color: white;
      border-color: #28a745;
    }
    .result-card .card-actions button.icon-btn {
      flex-grow: 0;
      padding: 8px;
      width: 38px;
    }

    /* Card Loader for Regenerate */
    .card-loader {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(255, 255, 255, 0.85);
        backdrop-filter: blur(4px);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 5;
        border-radius: var(--border-radius);
    }
    .card-loader .spinner {
        width: 36px;
        height: 36px;
        -webkit-mask: radial-gradient(farthest-side, #0000 calc(100% - 6px), #000 0);
    }

    /* Loader */
    #loader {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(240, 242, 245, 0.9);
      backdrop-filter: blur(8px);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 10;
      border-radius: var(--border-radius);
    }
    #loader p {
      font-size: 18px;
      font-weight: 500;
      margin-top: 16px;
    }
    #loader #loader-tip {
        font-size: 15px;
        color: var(--text-light);
        margin-top: 12px;
        font-style: italic;
        max-width: 80%;
        text-align: center;
        min-height: 22px; /* Prevent layout shift */
    }
    #loader span {
      font-size: 14px;
      color: var(--text-light);
    }
    .spinner {
      width: 56px;
      height: 56px;
      border-radius: 50%;
      background: conic-gradient(#0000 10%, var(--accent-color));
      -webkit-mask: radial-gradient(farthest-side, #0000 calc(100% - 9px), #000 0);
      animation: spinner-spin 1s infinite linear;
    }
    @keyframes spinner-spin {
      to { transform: rotate(1turn) }
    }

    /* Modal Styles */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.85);
      backdrop-filter: blur(8px);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 20px;
      cursor: pointer;
      overflow: hidden; /* Prevent scrollbars when panning */
    }
    #fullscreen-image {
      max-width: 95vw;
      max-height: 95vh;
      object-fit: contain;
      border-radius: 8px;
      cursor: default;
      box-shadow: 0 16px 64px rgba(0,0,0,0.3);
      transition: transform 0.2s ease-out;
      transform-origin: center center;
      will-change: transform;
    }
    #fullscreen-image.is-zoomed {
      cursor: grab;
    }
    #fullscreen-image.is-grabbing {
      cursor: grabbing;
    }
    .close-modal-btn {
      position: absolute;
      top: 20px;
      right: 30px;
      font-size: 40px;
      line-height: 1;
      color: white;
      background: none;
      border: none;
      cursor: pointer;
      text-shadow: 0 2px 8px rgba(0,0,0,0.5);
      z-index: 1003;
    }
    .zoom-controls {
      position: absolute;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.5);
      border-radius: 20px;
      padding: 8px;
      display: flex;
      gap: 8px;
      z-index: 1002;
    }
    .zoom-btn {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      border: none;
      background: rgba(255, 255, 255, 0.9);
      color: #333;
      font-size: 24px;
      font-weight: bold;
      cursor: pointer;
      line-height: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.2s, transform 0.2s;
    }
    .zoom-btn:hover {
      background: #fff;
      transform: scale(1.1);
    }
    
    /* Footer */
    footer {
      text-align: center;
      padding: 32px 24px;
      font-size: 14px;
      color: var(--text-light);
    }

    /* Responsive Design */
    @media (max-width: 1200px) {
      .main-container {
        grid-template-columns: 400px 1fr;
      }
    }

    @media (max-width: 992px) {
      .main-container {
        grid-template-columns: 1fr;
      }
    }

    @media (max-width: 576px) {
      .container {
        padding: 0 16px;
      }
      #prompt-form h2, #results-panel h2 {
        font-size: 20px;
      }
      .filters-grid {
        grid-template-columns: 1fr;
      }
      #results-grid {
        grid-template-columns: 1fr;
      }
      .main-container {
        gap: 24px;
      }
      #controls-panel, #results-panel {
        padding: 24px;
      }
    }
  </style>

  <script type="importmap">
    {
      "imports": {
        "@google/genai": "https://esm.sh/@google/genai@^0.14.0"
      }
    }
  </script>
</head>
<body>
  <header>
    <div class="container">
      <span class="logo">NapNox <strong>Studio</strong></span>
    </div>
  </header>

  <main>
    <div class="container main-container">
      <section id="controls-panel">
        <form id="prompt-form" aria-labelledby="form-title">
          <h2 id="form-title">âœ¨ Create Your Masterpiece</h2>
          
          <div class="form-group image-upload-group">
            <label id="image-upload-label" for="image-upload">1. Upload Your Photo</label>
            <div class="image-preview-wrapper" role="button" tabindex="0" aria-label="Upload image">
                <img id="image-preview" src="#" alt="Your uploaded image preview" class="hidden">
                <button id="remove-image-btn" class="remove-image-btn hidden" aria-label="Remove uploaded image">&times;</button>
                <div id="upload-placeholder">
                    <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>
                    <p>Click to upload JPG or PNG</p>
                </div>
            </div>
            <input type="file" id="image-upload" accept="image/jpeg, image/png">
          </div>

          <div class="form-group">
            <label id="user-prompt-label" for="user-prompt">2. Describe Your Vision</label>
            <textarea id="user-prompt" placeholder="e.g., Make me look like a cyberpunk hero" rows="3"></textarea>
          </div>
          
          <h3>ðŸŽ¨ Customize With Filters</h3>
          <div class="filters-grid">
            <!-- Generation Source -->
            <div class="form-group full-width">
                <label for="generation-source-fieldset">Generation Source</label>
                <div id="generation-source-fieldset" class="segmented-control">
                    <input type="radio" id="source-hybrid" name="generation-source" value="hybrid" checked>
                    <label for="source-hybrid">Image + Prompt</label>
                    <input type="radio" id="source-prompt" name="generation-source" value="prompt">
                    <label for="source-prompt">Prompt Only</label>
                    <input type="radio" id="source-image" name="generation-source" value="image">
                    <label for="source-image">Image Only</label>
                </div>
            </div>
            <!-- Resolution -->
             <div class="form-group">
                <label for="resolution">Resolution</label>
                <select id="resolution">
                    <option>1024x1024</option>
                    <option>512x512</option>
                    <option>2048x2048</option>
                </select>
            </div>
            <!-- Art Style -->
            <div class="form-group">
              <label for="art-style">Art Style</label>
              <select id="art-style">
                <option selected>Realistic</option>
                <option>Digital Art</option>
                <option>Cinematic</option>
                <option>3D Render</option>
                <option>Watercolor</option>
                <option>Pencil Sketch</option>
              </select>
            </div>
            <!-- Lighting Style -->
            <div class="form-group">
              <label for="lighting-style">Lighting Style</label>
              <select id="lighting-style">
                <option selected>Soft Light</option>
                <option>Natural</option>
                <option>Studio</option>
                <option>Dramatic</option>
                <option>Golden Hour</option>
              </select>
            </div>
            <!-- Color Tone -->
            <div class="form-group">
              <label for="color-tone">Color Tone</label>
              <select id="color-tone">
                <option>Cool</option>
                <option>Warm</option>
                <option>Neutral</option>
                <option selected>Vibrant</option>
                <option>Muted</option>
              </select>
            </div>
            <!-- Background Type -->
            <div class="form-group">
              <label for="background-type">Background Type</label>
              <select id="background-type">
                <option>Landscape</option>
                <option>Office</option>
                <option>Studio</option>
                <option>Abstract</option>
                <option>None (transparent)</option>
              </select>
            </div>
            <!-- Camera Angle -->
            <div class="form-group">
                <label for="camera-angle">Camera Angle</label>
                <select id="camera-angle">
                    <option selected>Portrait</option>
                    <option>Side Profile</option>
                    <option>Wide Shot</option>
                    <option>Top View</option>
                </select>
            </div>
            <!-- Facial Expression -->
            <div class="form-group">
                <label for="facial-expression">Facial Expression</label>
                <select id="facial-expression">
                    <option>Confident</option>
                    <option>Smiling</option>
                    <option>Focused</option>
                    <option selected>Natural</option>
                    <option>Serious</option>
                </select>
            </div>
            <!-- Age Adjustment -->
            <div class="form-group">
                <label for="age-adjustment">Age Adjustment</label>
                <select id="age-adjustment">
                    <option selected>Same</option>
                    <option>Younger</option>
                    <option>Older</option>
                </select>
            </div>
            <!-- Gender Swap -->
            <div class="form-group">
                <label for="gender-swap">Gender Swap</label>
                <select id="gender-swap">
                    <option selected>Off</option>
                    <option>On</option>
                </select>
            </div>
            <!-- Style Transfer -->
            <div class="form-group">
                <label for="style-transfer">Style Transfer</label>
                <select id="style-transfer">
                    <option selected>None</option>
                    <option>Van Gogh</option>
                    <option>Pixar</option>
                    <option>Cyberpunk</option>
                    <option>Fashion Editorial</option>
                </select>
            </div>
             <!-- Platform -->
            <div class="form-group">
                <label for="platform">Platform</label>
                <select id="platform">
                    <option selected>General Purpose</option>
                    <option>Social Media Post</option>
                    <option>Website Banner</option>
                    <option>Print Quality</option>
                </select>
            </div>
            <!-- Number of Variations -->
             <div class="form-group">
                <label for="num-variations">Number of Variations</label>
                <select id="num-variations">
                    <option>1</option>
                    <option>2</option>
                    <option selected>4</option>
                    <option>6</option>
                </select>
            </div>
            <!-- Aspect Ratio -->
            <div class="form-group">
                <label for="aspect-ratio">Aspect Ratio</label>
                <select id="aspect-ratio">
                    <option>1:1</option>
                    <option selected>16:9</option>
                    <option>9:16</option>
                    <option>3:2</option>
                </select>
            </div>
            <!-- Prompt Focus -->
            <div class="form-group">
                <label for="prompt-focus">Prompt Focus</label>
                <select id="prompt-focus">
                    <option selected>Balanced</option>
                    <option>Realistic</option>
                    <option>Artistic</option>
                    <option>Extreme Creative</option>
                </select>
            </div>
          </div>

          <button type="submit" id="generate-btn">ðŸŽ¨ Generate</button>
        </form>
      </section>
      
      <section id="results-panel" aria-live="polite">
        <h2>Your Creations</h2>
        <div id="loader" class="hidden">
            <div class="spinner"></div>
            <p>Creating your AI masterpiece...</p>
            <p id="loader-tip"></p>
            <span>This may take a moment.</span>
        </div>
        <div id="results-grid">
          <!-- Result cards will be injected here by JavaScript -->
        </div>
        <div id="results-placeholder">
          <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M15.5 6.5C15.5 5.25 14.75 4 13.5 4h-5C7.25 4 6.5 5.25 6.5 6.5v11C6.5 18.75 7.25 20 8.5 20h5c1.25 0 2-1.25 2-2.5v-11z"/><path d="M9.5 6h2"/><path d="M9.5 18h2"/><path d="M15.5 10h-11"/><path d="M15.5 14h-11"/></svg>
          <h3>Your Creations Await</h3>
          <p>Fill out the form, click 'Generate', and watch your ideas come to life right here.</p>
        </div>
      </section>
    </div>
  </main>

  <footer>
  </footer>

  <div id="fullscreen-modal" class="modal-overlay hidden">
    <button id="close-modal-btn" class="close-modal-btn" aria-label="Close fullscreen view">&times;</button>
    <div class="zoom-controls">
        <button id="zoom-in-btn" class="zoom-btn" title="Zoom In">+</button>
        <button id="zoom-out-btn" class="zoom-btn" title="Zoom Out">âˆ’</button>
    </div>
    <img src="" alt="Fullscreen generated image" id="fullscreen-image">
  </div>

  <script type="module">
    /**
     * @license
     * SPDX-License-Identifier: Apache-2.0
    */
    import { GoogleGenAI, Type, Modality } from "@google/genai";

    // --- DOM ELEMENT REFERENCES ---
    const form = document.getElementById('prompt-form');
    const imageUpload = document.getElementById('image-upload');
    const imagePreview = document.getElementById('image-preview');
    const uploadPlaceholder = document.getElementById('upload-placeholder');
    const imagePreviewWrapper = document.querySelector('.image-preview-wrapper');
    const removeImageBtn = document.getElementById('remove-image-btn');
    const imageUploadLabel = document.getElementById('image-upload-label');
    const userPromptLabel = document.getElementById('user-prompt-label');
    const userPromptTextarea = document.getElementById('user-prompt');
    const generateBtn = document.getElementById('generate-btn');
    const loader = document.getElementById('loader');
    const loaderTip = document.getElementById('loader-tip');
    const resultsPanel = document.getElementById('results-panel');
    const resultsGrid = document.getElementById('results-grid');
    const resultsPlaceholder = document.getElementById('results-placeholder');
    const fullscreenModal = document.getElementById('fullscreen-modal');
    const fullscreenImage = document.getElementById('fullscreen-image');
    const closeModalBtn = document.getElementById('close-modal-btn');
    const zoomInBtn = document.getElementById('zoom-in-btn');
    const zoomOutBtn = document.getElementById('zoom-out-btn');

    // --- GEMINI API SETUP ---
    // IMPORTANT: Replace "YOUR_API_KEY" with your actual Google AI Studio API key.
    const API_KEY = "YOUR_API_KEY";
    let ai;
    
    try {
        if (!API_KEY || API_KEY === "YOUR_API_KEY") {
            throw new Error("API_KEY not provided. Please replace 'YOUR_API_KEY' in the script.");
        }
        ai = new GoogleGenAI({ apiKey: API_KEY });
    } catch (error) {
        console.error("Failed to initialize GoogleGenAI:", error);
        alert("Fatal Error: Could not initialize Google AI. Please ensure you have replaced 'YOUR_API_KEY' in the HTML file with a valid key.");
    }

    // --- APPLICATION STATE & CONSTANTS ---
    const state = {
      uploadedImage: {
        base64: null,
        mimeType: null,
      },
      isLoading: false,
    };
    const creativeTips = [
        "Tip: Combining unexpected concepts can lead to surprising results!",
        "Did you know? 'Golden hour' lighting creates a warm, soft glow.",
        "Pro-tip: Use 'cinematic' in your prompt for a movie-like feel.",
        "Try using negative prompts to specify what you *don't* want in the image.",
        "The more specific your prompt, the closer the AI can get to your vision.",
        "Experiment with different art styles like 'watercolor' or '3D render'.",
        "AI is great at details. Try asking for specific textures or materials.",
        "Thinking of a mood... 'serene', 'chaotic', 'nostalgic'?",
    ];
    let tipInterval = null;

    // --- HELPER FUNCTIONS ---
    function getGenerationSource() {
        const checkedRadio = form.querySelector('input[name="generation-source"]:checked');
        return checkedRadio.value;
    }


    // --- EVENT LISTENERS ---
    imagePreviewWrapper?.addEventListener('click', () => imageUpload.click());

    imageUpload.addEventListener('change', async (event) => {
      const target = event.target;
      const file = target.files?.[0];
      if (file) {
        try {
          const { base64, mimeType } = await fileToBase64(file);
          state.uploadedImage.base64 = base64;
          state.uploadedImage.mimeType = mimeType;
          imagePreview.src = `data:${mimeType};base64,${base64}`;
          imagePreview.classList.remove('hidden');
          uploadPlaceholder?.classList.add('hidden');
          removeImageBtn.classList.remove('hidden');
        } catch (error) {
          console.error("Error reading file:", error);
          alert("Could not read the selected file. Please try another image.");
        }
      }
    });

    removeImageBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        state.uploadedImage.base64 = null;
        state.uploadedImage.mimeType = null;
        imagePreview.src = '#';
        imagePreview.classList.add('hidden');
        uploadPlaceholder?.classList.remove('hidden');
        removeImageBtn.classList.add('hidden');
        imageUpload.value = '';
    });

    form.addEventListener('submit', async (event) => {
      event.preventDefault();
      if (!ai) {
          alert("Google AI client is not initialized. Please check your API key in the code and reload the page.");
          return;
      }

      const source = getGenerationSource();
      if ((source === 'hybrid' || source === 'image') && !state.uploadedImage.base64) {
        alert("Please upload an image for this generation source.");
        return;
      }
      if ((source === 'hybrid' || source === 'prompt') && !userPromptTextarea.value.trim()) {
        alert("Please describe your vision in the prompt field.");
        return;
      }
      
      await handleGeneration();
    });

    form.addEventListener('change', (event) => {
        const target = event.target;
        if (target.name === 'generation-source') {
            updateFormUI();
        }
    });


    // --- CORE LOGIC ---
    async function handleGeneration() {
      setLoading(true);
      try {
        const creativePrompts = await generateCreativePrompts();
        const imageGenerationPromises = creativePrompts.map(prompt =>
          generateImage(prompt)
        );
        const generatedImages = await Promise.all(imageGenerationPromises);
        displayResults(generatedImages);

      } catch (error) {
        console.error("An error occurred during generation:", error);
        alert("An error occurred. Your API key might be invalid or there could be a network issue. Please check the console for details.");
        resultsPlaceholder.classList.remove('hidden');
      } finally {
        setLoading(false);
      }
    }

    async function generateCreativePrompts() {
      const numVariations = document.getElementById('num-variations');
      const generationSource = getGenerationSource();
      const aspectRatio = (document.getElementById('aspect-ratio')).value;

      let systemInstruction = '';
      if (generationSource === 'prompt') {
        systemInstruction = `You are a creative AI image prompt builder. Your job is to create refined, detailed, and imaginative prompts for a new image from scratch. Use the user's text and filter selections to produce well-structured prompt descriptions. Each prompt must be 1-2 sentences. The most critical instruction is that the final image MUST strictly match the aspect ratio of ${aspectRatio}. Explicitly mention this aspect ratio in every prompt you generate.`;
      } else {
        systemInstruction = `You are an expert AI photo editor. Your job is to create prompts that act as editing instructions for a user's uploaded image. The prompts must describe how to modify or transform the uploaded photo based on the provided filters and user text. Start prompts with phrases like "Modify the uploaded image..." or "Transform the person in the photo to...". Do NOT describe a new scene or person from scratch. The output must be an editing instruction. The most critical instruction is to ensure the final edited image respects the requested aspect ratio of ${aspectRatio}, for example by cropping, extending the background, or reframing the scene.`;
      }
      
      const promptDetails = Array.from(form.querySelectorAll('select, textarea'))
        .map(el => {
            const input = el;
            const label = form.querySelector(`label[for="${input.id}"]`)?.textContent || input.id;
            if (input.id === 'user-prompt' && (generationSource === 'image' || !input.value.trim())) return null;
            if (input.name === 'generation-source') return null;
            if (input.id === 'aspect-ratio') return `${label}: "${input.value}" (This is a strict requirement).`;
            return `${label}: "${input.value}"`;
        }).filter(Boolean).join('\n');
        
      const finalPrompt = `Generate ${numVariations.value} distinct and creative prompt variations based on the following details. PRIORITY #1: Each generated prompt MUST strictly adhere to and explicitly mention the requested aspect ratio of ${aspectRatio}. This is not optional.\n\n${promptDetails}`;
      
      const response = await ai.models.generateContent({
        model: 'gemini-2.5-flash',
        contents: finalPrompt,
        config: {
          systemInstruction,
          responseMimeType: "application/json",
          responseSchema: {
            type: Type.OBJECT,
            properties: { prompts: { type: Type.ARRAY, items: { type: Type.STRING } } }
          }
        }
      });

      const jsonResponse = JSON.parse(response.text);
      if (!jsonResponse.prompts || jsonResponse.prompts.length === 0) {
          throw new Error("AI did not return any prompts.");
      }
      return jsonResponse.prompts;
    }

    async function generateImage(prompt) {
      const textPart = { text: prompt };
      const parts = [textPart];
      
      const generationSource = getGenerationSource();
      if ((generationSource === 'hybrid' || generationSource === 'image') && state.uploadedImage.base64 && state.uploadedImage.mimeType) {
        const imagePart = {
          inlineData: {
            data: state.uploadedImage.base64,
            mimeType: state.uploadedImage.mimeType,
          },
        };
        parts.unshift(imagePart);
      }

      const response = await ai.models.generateContent({
        model: 'gemini-2.5-flash-image',
        contents: { parts },
        config: { responseModalities: [Modality.IMAGE] },
      });
      
      const firstPart = response.candidates?.[0]?.content?.parts?.[0];
      if (firstPart && 'inlineData' in firstPart && firstPart.inlineData) {
        return { prompt, imageBase64: firstPart.inlineData.data };
      } else {
        throw new Error("Could not extract image from Gemini response.");
      }
    }

    async function handleRegenerate(card, prompt) {
        const loader = card.querySelector('.card-loader');
        const img = card.querySelector('img');
        if (!loader || !img) return;

        loader.classList.remove('hidden');
        try {
            const { imageBase64 } = await generateImage(prompt);
            const newImageUrl = `data:image/png;base64,${imageBase64}`;
            img.src = newImageUrl;
            
            const downloadBtn = card.querySelector('.download-btn');
            downloadBtn.onclick = () => {
                const link = document.createElement('a');
                link.href = newImageUrl;
                link.download = `napnox-ai-image-${Date.now()}.png`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            };

            const viewBtn = card.querySelector('.view-btn');
            viewBtn.onclick = () => openModal(newImageUrl);

            const shareBtn = card.querySelector('.share-btn');
            if (shareBtn && navigator.share) {
                shareBtn.onclick = () => shareImage(newImageUrl, prompt);
            }
        } catch (error) {
            console.error("Regeneration failed:", error);
            alert("Failed to regenerate the image. Please try again.");
        } finally {
            loader.classList.add('hidden');
        }
    }

    async function shareImage(url, text) {
        try {
            const response = await fetch(url);
            const blob = await response.blob();
            const file = new File([blob], `napnox-ai-image-${Date.now()}.png`, { type: 'image/png' });

            if (navigator.canShare && navigator.canShare({ files: [file] })) {
                await navigator.share({
                    title: 'AI Image from NapNox Studio',
                    text: `Check out this image I created! Prompt: ${text}`,
                    files: [file],
                });
            } else {
                alert('Your browser does not support sharing this file.');
            }
        } catch (error) {
            console.error('Error sharing:', error);
            if (error.name !== 'AbortError') {
                alert('An error occurred while trying to share.');
            }
        }
    }

    // --- UI & HELPER FUNCTIONS ---
    function updateFormUI() {
        const source = getGenerationSource();
        if (source === 'prompt') {
            imageUploadLabel.textContent = '1. Upload Your Photo (Optional)';
            userPromptLabel.textContent = '2. Describe Your Vision (Required)';
        } else if (source === 'image') {
            imageUploadLabel.textContent = '1. Upload Your Photo (Required)';
            userPromptLabel.textContent = '2. Describe Your Vision (Optional)';
        } else { // Hybrid
            imageUploadLabel.textContent = '1. Upload Your Photo (Required)';
            userPromptLabel.textContent = '2. Describe Your Vision (Required)';
        }
    }

    function setLoading(isLoading) {
      state.isLoading = isLoading;
      generateBtn.disabled = isLoading;
      loader?.classList.toggle('hidden', !isLoading);
      
      if (isLoading) {
        resultsPanel.classList.remove('has-results');
        resultsPlaceholder?.classList.add('hidden');
        resultsGrid.innerHTML = '';
        
        const showRandomTip = () => {
            const randomIndex = Math.floor(Math.random() * creativeTips.length);
            loaderTip.textContent = creativeTips[randomIndex];
        };
        showRandomTip();
        tipInterval = window.setInterval(showRandomTip, 3500);

      } else {
          if (tipInterval) {
              clearInterval(tipInterval);
              tipInterval = null;
          }
          loaderTip.textContent = '';
      }
    }

    function displayResults(results) {
      resultsGrid.innerHTML = '';
      if (results.length === 0) {
          resultsPlaceholder.classList.remove('hidden');
          resultsPanel.classList.remove('has-results');
          return;
      }
      resultsPlaceholder.classList.add('hidden');
      results.forEach(result => {
        const card = createResultCard(result.prompt, result.imageBase64);
        resultsGrid.appendChild(card);
      });
      resultsPanel.classList.add('has-results');
    }

    function createResultCard(prompt, imageBase64) {
      const card = document.createElement('div');
      card.className = 'result-card';
      const imageUrl = `data:image/png;base64,${imageBase64}`;

      card.innerHTML = `
        <div class="card-loader hidden"><div class="spinner"></div></div>
        <img src="${imageUrl}" alt="${prompt.substring(0, 50)}...">
        <div class="prompt-info">
          <p class="prompt-text">${prompt}</p>
          <div class="card-actions">
            <button class="copy-btn">Copy Prompt</button>
            <button class="regenerate-btn">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M3 21v-5h5"/></svg>
                Regen
            </button>
            <button class="share-btn icon-btn" title="Share Image">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="18" cy="5" r="3"></circle><circle cx="6" cy="12" r="3"></circle><circle cx="18" cy="19" r="3"></circle><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"></line><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"></line></svg>
            </button>
            <button class="download-btn icon-btn" title="Download Image">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
            </button>
            <button class="view-btn icon-btn" title="View fullscreen">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"/></svg>
            </button>
          </div>
        </div>
      `;

      const copyBtn = card.querySelector('.copy-btn');
      copyBtn.addEventListener('click', () => {
        navigator.clipboard.writeText(prompt).then(() => {
          copyBtn.textContent = 'Copied!';
          copyBtn.classList.add('copied');
          setTimeout(() => {
            copyBtn.textContent = 'Copy Prompt';
            copyBtn.classList.remove('copied');
          }, 2000);
        });
      });

      const downloadBtn = card.querySelector('.download-btn');
      downloadBtn.onclick = () => {
          const link = document.createElement('a');
          link.href = imageUrl;
          link.download = `napnox-ai-image-${Date.now()}.png`;
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
      };

      const viewBtn = card.querySelector('.view-btn');
      viewBtn.onclick = () => openModal(imageUrl);

      const shareBtn = card.querySelector('.share-btn');
      if (navigator.share) {
        shareBtn.onclick = () => shareImage(imageUrl, prompt);
      } else {
        shareBtn.style.display = 'none';
      }

      const regenerateBtn = card.querySelector('.regenerate-btn');
      regenerateBtn.addEventListener('click', () => {
          handleRegenerate(card, prompt);
      });

      return card;
    }

    function fileToBase64(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => {
          const result = reader.result;
          const base64 = result.split(',')[1];
          resolve({ base64, mimeType: file.type });
        };
        reader.onerror = error => reject(error);
        reader.readAsDataURL(file);
      });
    }

    // --- MODAL LOGIC & CONTROLS ---
    const modalState = {
        zoom: 1,
        isDragging: false,
        pan: { x: 0, y: 0 },
        start: { x: 0, y: 0 },
    };

    function updateImageTransform() {
        if (!fullscreenImage) return;
        fullscreenImage.style.transform = `translate(${modalState.pan.x}px, ${modalState.pan.y}px) scale(${modalState.zoom})`;
    }

    function resetModalState() {
        modalState.zoom = 1;
        modalState.pan.x = 0;
        modalState.pan.y = 0;
        modalState.isDragging = false;
        updateImageTransform();
        fullscreenImage.classList.remove('is-zoomed', 'is-grabbing');
    }

    function closeModal() {
        if (!fullscreenModal) return;
        fullscreenModal.classList.add('hidden');
        resetModalState();
    }

    function openModal(imageUrl) {
        if (!fullscreenImage || !fullscreenModal) return;
        resetModalState();
        fullscreenImage.src = imageUrl;
        fullscreenModal.classList.remove('hidden');
    }

    if (fullscreenModal && fullscreenImage && closeModalBtn && zoomInBtn && zoomOutBtn) {
        closeModalBtn.addEventListener('click', closeModal);
        fullscreenModal.addEventListener('click', (e) => {
            if (e.target === fullscreenModal) closeModal();
        });
        zoomInBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            modalState.zoom += 0.2;
            fullscreenImage.classList.add('is-zoomed');
            updateImageTransform();
        });
        zoomOutBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            modalState.zoom = Math.max(1, modalState.zoom - 0.2);
            if (modalState.zoom === 1) {
                fullscreenImage.classList.remove('is-zoomed');
                modalState.pan.x = 0;
                modalState.pan.y = 0;
            }
            updateImageTransform();
        });
        fullscreenImage.addEventListener('mousedown', (e) => {
            if (modalState.zoom <= 1) return;
            e.preventDefault();
            modalState.isDragging = true;
            modalState.start.x = e.clientX - modalState.pan.x;
            modalState.start.y = e.clientY - modalState.pan.y;
            fullscreenImage.classList.add('is-grabbing');
        });
        fullscreenImage.addEventListener('mousemove', (e) => {
            if (!modalState.isDragging) return;
            e.preventDefault();
            modalState.pan.x = e.clientX - modalState.start.x;
            modalState.pan.y = e.clientY - modalState.start.y;
            updateImageTransform();
        });
        const stopDragging = () => {
            if (modalState.isDragging) {
                modalState.isDragging = false;
                fullscreenImage.classList.remove('is-grabbing');
            }
        };
        window.addEventListener('mouseup', stopDragging);
        fullscreenImage.addEventListener('mouseleave', stopDragging);
    }

    // --- INITIAL APP STARTUP ---
    updateFormUI();
  </script>
</body>
</html>
